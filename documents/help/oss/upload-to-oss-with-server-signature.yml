ROSTemplateFormatVersion: '2015-09-01'
Description:
  zh-cn: 从服务器获取签名信息并上传数据到OSS。
  en: Obtain signature information from the server and upload data to OSS.
Parameters:
  SystemDiskCategory:
    AssociationProperty: ALIYUN::ECS::Disk::SystemDiskCategory
    AssociationPropertyMetadata:
      InstanceType: ${InstanceType}
      ZoneId: ${ZoneId}
    Type: String
    Label:
      zh-cn: 系统盘类型
      en: System Disk Category
  IP:
    Type: String
    Description:
      zh-cn: 输入您的IP信息，<b><a href='https://www.ip.cn/' target='_blank'><font color='blue'>IP查询地址</font></a></b>。
      en: Enter your IP information,<b><a href="https://www.ip.cn/" target ="_blank"><fontcolor='blue'> IP address query </font> </a> </b>.
    Label:
      zh-cn: IP 地址
      en: IP Address
  ZoneId:
    AssociationProperty: ALIYUN::VPC::Zone::ZoneId
    Type: String
    Description:
      zh-cn: 可用区ID，需确认所选可用区下是否支持ECS、VPC、VSwitch等资源。
      en: The available zone ID, you should confirm the zone support ECS、VPC、VSwitch or not.
    Label:
      zh-cn: 可用区ID
      en: Zone ID
  BucketName:
    AssociationPropertyMetadata:
      Length: 6
      Prefix: testbucketname-
      CharacterClasses:
        - Class: lowercase
          min: 1
    Description:
      zh-cn: Bucket 名称在 OSS 范围内必须全局唯一。长度为3~63个字符。必须以小写英文字母或数字开头和结尾，可包含小写英文字母、数字和短划线（-）。
      en: Bucket names must be globally unique within the scope of OSS. The length is 3~63 characters. Must start and end with a lowercase English letter or number, and can contain lowercase English letters, numbers, and dashes (-).
    Label:
      zh-cn: 新建存储空间名称
      en: NewBucketName
    AllowedPattern: ^[a-z0-9][a-z0-9-]{1,61}[a-z0-9]$
    AssociationProperty: AutoCompleteInput
    Type: String
  Password:
    Description:
      zh-cn: 长度为8-30位，需包含大写字母、小写字母、特殊符号和数字中的三个，允许的特殊字符包括<span style="background:#E7E9EB;"><b>()`~!@#$%^&*_-+=|{}[]:;'<>,.?/</b></span>。
      en: |-
        The password must be 8 to 32 characters in length. <br>
        It must consist three of the the following character types: uppercase letters, lowercase letters, digits, and special characters. <br>
        Special characters include <span style="background:#E7E9EB;"><b>()`~!@#$%^&*_-+=|{}[]:;'<>,.?/</b></span>.<br>
    Default: Null
    MinLength: 8
    Label:
      zh-cn: 实例密码
      en: Login Password
    AllowedPattern: '[0-9A-Za-z\_\-&:;''<>,=%`~!@#\(\)\$\^\*\+\|\{\}\[\]\.\?\/]+$'
    NoEcho: true
    MaxLength: 30
    Type: String
  InstanceType:
    AssociationProperty: ALIYUN::ECS::Instance::InstanceType
    AssociationPropertyMetadata:
      ZoneId: ${ZoneId}
    Type: String
    Label:
      zh-cn: 实例类型
      en: Instance Type
Outputs:
  OssClientAddress:
    Description:
      zh-cn: 客户端地址，使用此地址可直接体验文件上传。
      en: Client address, use this address to directly experience file upload.
    Value:
      Fn::Sub: http://${Eip.EipAddress}:3001/index.html
Resources:
  Eip:
    Type: ALIYUN::VPC::EIP
    Properties:
      InternetChargeType: PayByTraffic
      Bandwidth: 5
      Name: create_by_document
  SecurityGroupIngress_22:
    Type: ALIYUN::ECS::SecurityGroupIngress
    Properties:
      IpProtocol: tcp
      SecurityGroupId:
        Ref: SecurityGroup
      NicType: intranet
      SourceCidrIp:
        Ref: IP
      PortRange: 22/22
  EipAssociation:
    Type: ALIYUN::VPC::EIPAssociation
    Properties:
      InstanceId:
        Fn::Select:
          - 0
          - Fn::GetAtt:
              - InstanceGroup
              - InstanceIds
      AllocationId:
        Fn::GetAtt:
          - Eip
          - AllocationId
  SecurityGroupIngress_3001:
    Type: ALIYUN::ECS::SecurityGroupIngress
    Properties:
      IpProtocol: tcp
      SecurityGroupId:
        Ref: SecurityGroup
      NicType: intranet
      SourceCidrIp:
        Ref: IP
      PortRange: 3001/3001
  AccessKey:
    Type: ALIYUN::RAM::AccessKey
    Properties:
      UserName:
        Ref: User
  InstanceGroup:
    Type: ALIYUN::ECS::InstanceGroup
    Properties:
      SystemDiskCategory:
        Ref: SystemDiskCategory
      VpcId:
        Ref: Vpc
      SecurityGroupId:
        Ref: SecurityGroup
      ImageId: centos_7
      AllocatePublicIP: false
      VSwitchId:
        Ref: VSwitch
      IoOptimized: optimized
      Password:
        Ref: Password
      InstanceType:
        Ref: InstanceType
      MaxAmount: 1
  Bucket:
    Type: ALIYUN::OSS::Bucket
    Properties:
      BucketName:
        Ref: BucketName
      CORSConfiguration:
        CORSRule:
          - AllowedHeader:
              - '*'
            AllowedOrigin:
              - '*'
            AllowedMethod:
              - POST
      DeletionForce: true
  SecurityGroup:
    Type: ALIYUN::ECS::SecurityGroup
    Properties:
      VpcId:
        Ref: Vpc
  Role:
    Type: ALIYUN::RAM::Role
    Properties:
      RoleName:
        Fn::Sub: ram-oss-test-create-by-${ALIYUN::StackId}
      Policies:
        - PolicyName:
            Fn::Sub: policy-create-by-${ALIYUN::StackId}
          PolicyDocument:
            Version: '1'
            Statement:
              - Action:
                  - oss:PutObject
                Resource:
                  - Fn::Sub: acs:oss:*:*:${Bucket.Name}/*
                Effect: Allow
      AssumeRolePolicyDocument:
        Version: '1'
        Statement:
          - Action: sts:AssumeRole
            Effect: Allow
            Principal:
              RAM:
                - Fn::Sub: acs:ram::${ALIYUN::TenantId}:root
  User:
    Type: ALIYUN::RAM::User
    Properties:
      UserName:
        Fn::Sub: user-create-by-${ALIYUN::StackId}
      PolicyAttachments:
        System:
          - AliyunSTSAssumeRoleAccess
  Vpc:
    Type: ALIYUN::ECS::VPC
    Properties:
      CidrBlock: 192.168.0.0/16
  VSwitch:
    Type: ALIYUN::ECS::VSwitch
    Properties:
      VpcId:
        Ref: Vpc
      CidrBlock: 192.168.0.0/24
      ZoneId:
        Ref: ZoneId
  ServerCommand:
    Type: ALIYUN::ECS::RunCommand
    Properties:
      CommandContent:
        Fn::Sub: |-
          #!/bin/bash
          yum -y install unzip

          curl -o- https://gitee.com/mirrors/nvm/raw/v0.39.7/install.sh | bash
          source /root/.bashrc
          nvm install 16

          wget -O server-signed-direct-upload.zip 'https://help-static-aliyun-doc.aliyuncs.com/file-manage-files/zh-CN/20240626/xfnqmy/server-signed-direct-upload.zip'
          unzip -o server-signed-direct-upload.zip
          rm -rf server-signed-direct-upload.zip
          cat > /root/server-signed-direct-upload/node-html-post-object/server/config.js << EOF
          module.exports = {
            accessKeyId: "${AccessKey.AccessKeyId}",
            accessKeySecret: "${AccessKey.AccessKeySecret}",
            region: "oss-${ALIYUN::Region}",
            bucket: "${Bucket.Name}",
            roleArn: "${Role.Arn}",
          };
          EOF
          sed -i 's/127.0.0.1/${Eip.EipAddress}/g' /root/server-signed-direct-upload/node-html-post-object/index.html
          cd /root/server-signed-direct-upload/node-html-post-object/
          source /root/.bashrc
          nohup npm start > output.log 2>&1 &
      Type: RunShellScript
      Sync: true
      InstanceIds:
        Fn::GetAtt:
          - InstanceGroup
          - InstanceIds
      Timeout: 3600
    DependsOn:
      - SecurityGroupIngress_3001
      - SecurityGroupIngress_22
      - EipAssociation
Metadata:
  ALIYUN::ROS::Interface:
    ParameterGroups:
      - Parameters:
          - BucketName
          - ZoneId
          - IP
          - InstanceType
          - SystemDiskCategory
          - Password
    TemplateTags:
      - acs:document-help:oss:服务端签名后直传
